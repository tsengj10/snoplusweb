{% extends "base.html" %}
{% load staticfiles %}
{% load tz %}
{% block title %}
Bookings list
{% endblock %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href='{% static "js/jquery-ui-1.11.4/jquery-ui.min.css" %}'>
<link rel="stylesheet" href='{% static "js/jquery.multiselect.css" %}'>
<link rel="stylesheet" href='{% static "js/jquery.multiselect.filter.css" %}'>
<script src='{% static "js/jquery-1.12.0.min.js" %}'></script>
<script src='{% static "js/jquery-ui-1.11.4/jquery-ui.min.js" %}'></script>
<script src='{% static "js/jquery-cookie-1.4.1/jquery.cookie.js" %}'></script>
<script src='{% static "js/jquery.multiselect.min.js" %}'></script>
<script src='{% static "js/jquery.multiselect.filter.js" %}'></script>
<script src='{% static "js/moment.min.js" %}'></script>
<script src='{% static "js/moment-timezone-with-data.min.js" %}'></script>

<style>
input.dpicker { width: 6em }
input.tpicker { width: 6em }
p.centered { text-align: center; }
tr.conflict { color: red }
table.tcentered {
  margin-left: auto;
  margin-right: auto;
  border-collapse: collapse;
  border: 1px solid black;
}
table.tboxed {
  border-collapse: collapse;
  border: 1px solid black;
}
td, th { padding: 5px; }
p#messages { color: red; }

tbody tr td.busy a.ui-state-default {
  background-color: Green;
  background-image: none;
  color: White;
  font-weight: bold;
}
tr td.partbusy a.ui-state-default {
  background-color: Magenta;
  background-image: none;
  color: White;
  font-weight: bold;
}
table tbody tr td.conflict a.ui-state-default {
  background-color: Red;
  background-image: none;
  color: White;
  font-weight: bold;
}
table tbody tr td.selected a.ui-state-default {
  background-color: Blue;
  background-image: none;
  color: White;
  font-weight: bold;
}
</style>
{% endblock %}
{% block content %}

<p>
<select id='select_resource' multiple='multiple'></select>
<select id='select_user' multiple='multiple'></select>
<select id='select_tz' multiple='multiple'></select>
</p>

<p>
<div id='begindate'></div>
</p>

<p>
<table class='tboxed' border="1">
<tr>
  <td>Begin</td>
  <td id='startdate'></td>
  <td><input id='starttime' class='tpicker' type='text'></td>
</tr>
<tr>
  <td>End</td>
  <td id='stopdate'></td>
  <td><input id='stoptime' class='tpicker' type='text'></td>
</tr>
<tr>
  <td><button id='request_button'>Book</button></td>
  <td><button id='clear_date'>Clear date range</button></td>
  <td><button id='clear_time'>Default times</button></td>
</table>

<p id="messages"></p>

<p id='details'></p>

{% endblock %}
{% block scripts %}
<script>

// configuration information
var resources = [];
var users = [];
var groups = [];

// to add, busy_days[new Date()] = tooltip
// (actually should use moment objects instead?)
var busy_days = {};
var conflict_days = {};

// booking data
var bdata = [];
var lastfetchtime = $.now(); // ms since 1 Jan 1970
var msday = 24*60*60*1000; // ms in a day
// current range of booking data fetched
var bdbegin = lastfetchtime - 32*msday; // 31 days past
var bdend = lastfetchtime + 400*msday; // 400 days in future
// current first date being displayed (need to check timezone by now!)
var fd1 = new Date();
fd1.setDate(1);
var displaybegin = fd1.getTime(); // first of month
var displayend = displaybegin + 92 * msday; // 92 days should clear 3 months
// check sometime whether starts display in next month!

// date selection
var dsbegin = null; // Date (use getTime to compare)
var dsend = null;

// ways to update the displayed calendar
function update_bookings() {
  var bd = {};
  bdata.forEach(function(d, j) {
    if (d.e.getTime() < displaybegin) return; // clearly ends before display range
    if (d.b.getTime() > displayend) return; // clearly begins after display range
    var dt0 = d.b.clone().clearTime();
    var dt1 = d.e.clone().clearTime();
    var daybook = dt0.equals(dt1); // color anyway
    while (daybook || !dt0.equals(dt1)) {
      if (bd[dt0]) {
      } else {
        bd[dt0] = [ users[d.u].n ];
      }
      if (daybook) break;
      else dt0.addDays(1);
    }
  });
  $('#begindate').datepicker('refresh');
}

function update_selection() {
  $('#begindate').datepicker('refresh');
  if (dsbegin == null || dsend == null) return;
  bdata.forEach(function(d, j) {
    var rbegin = d.b.getTime();
    var rend = d.e.getTime();
    if ((rbegin < dsend && rend > dsbegin) ||
        (dsbegin < rend && dsend > rbegin)) {
      $('#det' + d.b).addClass("conflict");
    } else {
      $('#det' + d.b).removeClass("conflict");
    }
  });
}

function reload_bookings() {
  $.getJSON('{% url "swap:bookings_json" %}',
            { 'b1': Math.floor(bdbegin/1000), 'e0': Math.floor(bdend/1000) },
            fill_bookings);
}

function update_days() {
  var bd = {};
  var rd = {};
  var cd = [];
  bdata.forEach(function(d,j) {
    var dt0 = d.b.clone().clearTime();
    var dt1 = d.e.clone().clearTime();
    var daybook = dt0.equals(dt1); // color anyway
    while (daybook || !dt0.equals(dt1)) {
      if (bd[dt0]) {
        if (bd[dt0].indexOf(users[d.u].n) < 0) bd[dt0].push(users[d.u].n);
      } else {
        bd[dt0] = [ users[d.u].n ];
      }
      if (rd[dt0]) {
        if (rd[dt0].indexOf(d.r) < 0) rd[dt0].push(d.r);
        else cd.push(dt0); // same resource on this day, potential conflict
      } else {
        rd[dt0] = [ d.r ];
      }
      if (daybook) break;
      else dt0.addDays(1);
    }
  });

  busy_days = {};
  conflict_days = {};
  $.each(bd, function(k,v) {
    busy_days[k] = v.join();
  });
  cd.forEach(function(d,j) {
    // check whether there's an overlap in time
  });

  $('#begindate').datepicker('refresh');
}

$.datepicker.setDefaults({
  //"dateFormat": "dd/mm/yy",
  "dateFormat": "dd M yy",
  "beforeShowDay": function(date) {
    var conflict = conflict_days[date];
    if (conflict) {
      return [ true, "conflict", conflict ];
      // selectable, class, optional tooltip
    } else {
      var busy = busy_days[date];
      if (busy) {
        return [ true, "busy", busy ];
      } else {
        return [ true, '', '' ];
      }
    }
    // part busy?

    // check select range
    var ts = date.valueOf();
    if (ts >= dsbegin && ts < dsend) return [ true, "selected" ];
  }
});

// based on http://www.timlabonne.com/2013/07/parsing-a-time-string-with-javascript/
// understands 1pm, 1:00pm, 1:00p, 13:00.  Returns NaN if can't parse at all.
function parseTime(timeStr, dt) {
  if (!dt) {
    dt = new Date();
  }
 
  var time = timeStr.match(/(\d+)(?::(\d\d))?\s*(p?)/i);
  if (!time) {
    return NaN;
  }
  var hours = parseInt(time[1], 10);
  dt.setHours(hours);
  dt.setMinutes(parseInt(time[2], 10) || 0);
  dt.setSeconds(0, 0);
  return dt;
}

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

var csrftoken = $.cookie('csrftoken');
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
//"csrfmiddlewaretoken" is a key in your posted data,for example,
//when you need to ajax login,your posted data may like this:
// {'username':'username','password':'password',
//  'csrfmiddlewaretoken':'CSRF-TOKEN-V<U+200C><U+200B>ALUE'} â€“ 

var old_default_begin = "";
var old_default_end = "";
var old_default_zone = "";

$(document).ready(function() {

  // get configuration information
  $.getJSON('{% static "json/config.json" %}', function(indata) {
    data = indata.data;
    data.res.forEach(function(d,j) {
      resources[d.pk] = {
        'n': d.name,
        'dbt': d.dbt,
        'det': d.det };
    });
    data.us.forEach(function(d,j) { users[d.pk] = { 'n': d.name }; });
    var hsr = [];
    // order resources by user group
    for (var i = 0; i < data.gs.length; ++i) {
      var ga = data.gs[i].ru;
      if (ga.length > 0) {
        hsr.push('<optgroup label="' + data.gs[i].name + '">');
        for (var j = 0; j < ga.length; ++j) {
          var rpk = ga[j];
          hsr.push('<option value="' + rpk + '">' + resources[rpk].n + '</option>');
        }
        hsr.push('</optgroup>');
      }
    }
    // order users (should be sorted by makeconfig)
    var hsu = [];
    for (var i = 0; i < data.us.length; ++i) {
      hsu.push('<option value="' + data.us[i].pk + '">' +
               data.us[i].n1 + ' ' + data.us[i].n2 + '</option>');
    }
    // timezone list
    var hzs = [];
    for (var i = 0; i < data.tzs.length; ++i) {
      hzs.push('<option value="' + data.tzs[i] + '">' + data.tzs[i] + "</option>");
    }

    $('#select_resource').html(hsr.join('')).multiselect({
      multiple: false,
      close: update_days,
      noneSelectedText: 'Select resource',
      selectedList: 1
    }).multiselectfilter();
    $('#select_user').html(hsu.join('')).multiselect({
      multiple: false,
      close: update_days,
      noneSelectedText: 'Select user',
      selectedList: 1
    }).multiselectfilter();
    $('#select_tz').html(hzs.join('')).multiselect({
      multiple: false,
      header: "Select timezone",
      selectedList: 1
    });
    $('#select_tz').val(data.tzs[0]);
    $('#select_tz').multiselect("refresh");
    $('#clear_date').button();
    $('#clear_time').button();
    $('#request_button').button();

    // set default value based on group (but may not exist)
    $('#starttime').prop('value', old_default_begin);
    $('#stoptime').prop('value', old_default_end);

    data.gs.forEach(function(d,j) { groups[d.pk] = d.name });

    reload_bookings();
  });

  // datepickers
  $('#begindate').datepicker({
    defaultDate: '+1w',
    changeMonth: true,
    changeYear: true,
    numberOfMonths: 3,
    onChangeMonthYear: function(year, month, inst) {
      console.log("onChangeMonthYear " + year + " " + month);
      displaybegin = new Date(year, month-1, 1).getTime();
      displayend = displaybegin + 92 * msday;
      console.log("displaybegin = " + new Date(displaybegin));
      // check whether we need more data
      var moredata = false;
      if (displaybegin < bdbegin) {
        moredata = true;
        bdbegin = displaybegin;
      }
      if (displayend > bdend) {
        moredata = true;
        bdend = displayend + 400 * msday;
      }
      if (moredata) reload_bookings();
      update_days(); // update list of days, remember month range 1-12
      // check range to see if need new data
    },
    onSelect: function(dateText) {
      var ds = $('#begindate').datepicker('getDate'); // timezone?
      var dst = ds.getTime();
      if (dsbegin == null) {
        dsbegin = new Date(ds);
      } else if (dsend == null) {
        dsend = new Date(ds);
      } else if (dst < dsbegin.getTime()) {
        dsbegin.setTime(ds);
      } else if (dst > dsend.getTime()) {
        dsend.setTime(ds);
      } else if (dst - dsbegin.getTime() < dsend.getTime() - dst) {
        dsbegin.setTime(ds);
      } else {
        dsend.setTime(ds);
      }
      update_selection();
      if (dsbegin != null) $('#startdate').html(dsbegin.toDateString());
      if (dsend != null) $('#stopdate').html(dsend.toDateString());
    }
  });

  // buttons
  $('#request_button').click(function() {
    var bdt = new Date();
    var edt = new Date();
    parseTime($('#starttime').prop('value'), bdt);
    parseTime($('#stoptime').prop('value'), edt);
    var reqs = { 'm': 'r',
                 'r': $('#select_resource').val(), 
                 'b': [ dsbegin.getFullYear(), dsbegin.getMonth()+1, dsbegin.getDate(),
                        bdt.getHours(), bdt.getMinutes() ],
                 'e': [ dsend.getFullYear(), dsend.getMonth()+1, dsend.getDate(),
                        edt.getHours(), edt.getMinutes() ],
                 'z': $('#select_tz').val()[0]
               };
    //console.log(JSON.stringify(reqs));
    //var qstring = window.location.href.slice(window.location.href.indexOf('?'));
    $.post('', JSON.stringify(reqs), function(data) {
      var msg = data.messages;
      var t = [];
      if (msg.length > 0) {
        t.push('<ul>');
        for (var i = 0; i < msg.length; ++i) t.push('<li>' + msg[i]);
        t.push('</ul>');
        $('#messages').html(t.join(''));
      } else {
        $('#messages').html('');
      }
    }, 'json');
    reload_bookings();
  });
  $('#clear_date').click(function() {
    dsbegin = null;
    dsend = null;
    $('#startdate').html('');
    $('#stopdate').html('');
    update_selection();
  });
  $('#clear_time').click(function() {
    var rpk = $('#select_resource').val();
    if (rpk != null) {
      $('#starttime').prop('value', resources[rpk].dbt);
      $('#stoptime').prop('value', resources[rpk].det);
    }
    if (dsbegin != null && dsend != null) update_selection();
  });


  $('#select_tz').change(function() {
    // need to redraw calendar with new timezone.
    // also move dsbegin and dsend to new timezone.
  });

  $('#select_resource').change(function() {
    var r = $('#select_resource').val();
    var rpk = 0;
    for (var i = 0; i < data.res.length; ++i) {
      if (r == data.res[i].pk) {
        rpk = i;
        break;
      }
    }
    var v = $('#starttime').prop('value');
    if (v == old_default_begin || v == "" || old_default_begin == "") {
      old_default_begin = data.res[rpk].dbt;
      $('#starttime').prop('value', old_default_begin);
    }
    v = $('#stoptime').prop('value');
    if (v == old_default_end || v == "" || old_default_end == "") {
      old_default_end = data.res[rpk].det;
      $('#stoptime').prop('value', old_default_end);
    }
    v = $('#select_tz').prop('value');
    if (v == old_default_zone || v == "" || old_default_zone == "") {
      old_default_zone = data.res[rpk].dz;
      $('#select_tz').prop('value', old_default_zone);
    }
  });

});

// year, month, day, hour, minute (but server sends in UTC zone)
function from_date_array(a) {
  //return new Date(a[0], a[1]-1, a[2], a[3], a[4]);
  var b = [ a[0], a[1]-1, a[2], a[3], a[4], 0, 0 ];
  return moment.utc(b);
}

function fill_bookings(data) {
  console.log('fill_bookings()');
  console.log(data);
  var s = [];
  s.push('<table class="tboxed"><tr><th>In</th><th>Out</th><th>Name</th><th>Group</th></tr>');
  data.b.forEach(function(d,j) {
    var a = { 'u': d.u, 'b': d.b, 'g': d.g, 'r': d.r,
              'tb': from_date_array(d.b), 'te': from_date_array(d.e),
              'tr': from_date_array(d.tr), 'tm': from_date_array(d.tm) };
    bdata.push(a);
    s.push('<tr id="det"' + d.b + '><td>' + a.tb.format('ddd D MMM YY H:mm z') + '</td><td>' +
                        a.te.format('ddd D MMM YY H:mm z') + '</td><td>' +
                        users[d.u].n + '</td><td>' +
                        groups[d.g] + '</td></tr>');
  });
  s.push('</table>');
  update_days();
  // need to do a deep copy of data to current_data;
  // or change update_days to select from persistent selectors

  // list bookings
  $('#details').html(s.join(''));
}

</script>
{% endblock %}
